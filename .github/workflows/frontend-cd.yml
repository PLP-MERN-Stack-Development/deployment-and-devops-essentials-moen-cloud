name: Frontend CD - Deploy to Render

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-cd.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Render
    runs-on: windows-latest
    environment:
      name: production
      url: https://deployment-and-devops-essentials-moen.onrender.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Render Deploy
        run: |
          echo "üöÄ Triggering Render deployment..."
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}")
          
          if [ $response -eq 200 ] || [ $response -eq 201 ]; then
            echo "‚úÖ Deployment triggered successfully (HTTP $response)"
          else
            echo "‚ùå Deployment trigger failed (HTTP $response)"
            exit 1
          fi
      
      - name: Wait for deployment
        run: |
          echo "‚è≥ Waiting for Render to build and deploy..."
          echo "Frontend builds typically take 3-5 minutes"
          sleep 180
      
      - name: Health check with retries
        run: |
          echo "üè• Checking frontend availability..."
          max_retries=15
          retry_count=0
          wait_time=15
          
          while [ $retry_count -lt $max_retries ]; do
            echo "Attempt $((retry_count + 1))/$max_retries..."
            
            if curl -f -s https://deployment-and-devops-essentials-moen.onrender.com > /dev/null; then
              echo "‚úÖ Frontend is live!"
              exit 0
            fi
            
            retry_count=$((retry_count + 1))
            
            if [ $retry_count -lt $max_retries ]; then
              echo "‚è≥ Frontend not ready yet. Waiting ${wait_time}s before retry..."
              sleep $wait_time
            fi
          done
          
          echo "‚ùå Health check failed after $max_retries attempts"
          echo "Please check Render logs: https://dashboard.render.com"
          exit 1
      
      - name: Test frontend routes
        run: |
          echo "üß™ Testing frontend routes..."
          base_url="https://deployment-and-devops-essentials-moen.onrender.com"
          
          # Test home page
          echo "Testing: $base_url"
          curl -f -s "$base_url" > /dev/null && echo "‚úÖ Home page works" || echo "‚ùå Home page failed"
          
          # Test React Router routes (should all return 200 and serve index.html)
          echo "Testing: $base_url/bugs"
          curl -f -s "$base_url/bugs" > /dev/null && echo "‚úÖ /bugs route works" || echo "‚ùå /bugs route failed"
          
          echo "‚úÖ Frontend deployment verification complete!"
      
      - name: Test API connectivity from frontend
        run: |
          echo "üîó Testing backend connectivity..."
          # This simulates what the frontend will do
          curl -f -s https://bug-tracker-backend-2z4i.onrender.com/api/health && \
            echo "‚úÖ Frontend can reach backend API" || \
            echo "‚ö†Ô∏è  Backend API connectivity issue"
        continue-on-error: true

  notify:
    name: Send Notifications
    runs-on: windows-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Send Slack notification
        if: always() && secrets.SLACK_WEBHOOK != ''
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            emoji="‚úÖ"
            color="good"
            text="Frontend deployment successful!"
          else
            emoji="‚ùå"
            color="danger"
            text="Frontend deployment failed!"
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$emoji Frontend Deployment ${{ needs.deploy.result }}\",
              \"attachments\": [{
                \"color\": \"$color\",
                \"fields\": [
                  {\"title\": \"Status\", \"value\": \"$text\", \"short\": false},
                  {\"title\": \"Branch\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": true},
                  {\"title\": \"URL\", \"value\": \"https://deployment-and-devops-essentials-moen.onrender.com\", \"short\": false}
                ]
              }]
            }" || echo "Slack notification failed"
        continue-on-error: true
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && needs.deploy.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Frontend deployed successfully to Render!\n\n**URL:** https://deployment-and-devops-essentials-moen.onrender.com\n**Backend API:** https://bug-tracker-backend-2z4i.onrender.com'
            })
        continue-on-error: true