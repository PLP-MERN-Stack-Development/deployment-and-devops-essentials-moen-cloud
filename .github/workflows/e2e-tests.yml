name: E2E Tests - Production

on:
  push:
    branches: [ main ]
  schedule:
    # Run every day at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  smoke-test:
    name: Production Smoke Tests
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test Backend Health
        run: |
          echo "üè• Testing backend health..."
          response=$(curl -s https://bug-tracker-backend-2z4i.onrender.com/api/health)
          
          if echo "$response" | grep -q "OK"; then
            echo "‚úÖ Backend health check passed"
            echo "$response" | jq '.'
          else
            echo "‚ùå Backend health check failed"
            echo "$response"
            exit 1
          fi
      
      - name: Test Frontend Availability
        run: |
          echo "üåê Testing frontend availability..."
          status_code=$(curl -s -o /dev/null -w "%{http_code}" https://deployment-and-devops-essentials-moen.onrender.com)
          
          if [ "$status_code" -eq 200 ]; then
            echo "‚úÖ Frontend is accessible (HTTP $status_code)"
          else
            echo "‚ùå Frontend returned HTTP $status_code"
            exit 1
          fi
      
      - name: Test API Endpoints
        run: |
          echo "üîç Testing API endpoints..."
          
          # Test GET /api/bugs
          echo "Testing GET /api/bugs..."
          bugs_response=$(curl -s -w "\n%{http_code}" https://bug-tracker-backend-2z4i.onrender.com/api/bugs)
          bugs_status=$(echo "$bugs_response" | tail -n 1)
          bugs_body=$(echo "$bugs_response" | sed '$d')
          
          if [ "$bugs_status" -eq 200 ]; then
            echo "‚úÖ GET /bugs returned 200"
            echo "$bugs_body" | jq '.count' || echo "Response: $bugs_body"
          else
            echo "‚ùå GET /bugs returned $bugs_status"
            exit 1
          fi
          
          # Test GET /api/bugs/stats
          echo "Testing GET /api/bugs/stats..."
          stats_status=$(curl -s -o /dev/null -w "%{http_code}" https://bug-tracker-backend-2z4i.onrender.com/api/bugs/stats)
          
          if [ "$stats_status" -eq 200 ]; then
            echo "‚úÖ GET /bugs/stats returned 200"
          else
            echo "‚ùå GET /bugs/stats returned $stats_status"
            exit 1
          fi
      
      - name: Test CORS Configuration
        run: |
          echo "üîê Testing CORS headers..."
          cors_header=$(curl -s -H "Origin: https://deployment-and-devops-essentials-moen.onrender.com" \
            -I https://bug-tracker-backend-2z4i.onrender.com/api/health | \
            grep -i "access-control-allow-origin" || echo "No CORS header")
          
          echo "CORS Header: $cors_header"
          
          if echo "$cors_header" | grep -q "access-control-allow-origin"; then
            echo "‚úÖ CORS is configured"
          else
            echo "‚ö†Ô∏è  CORS header not found (might be okay for some requests)"
          fi
      
      - name: Test Database Connection
        run: |
          echo "üóÑÔ∏è  Testing database connectivity..."
          health_response=$(curl -s https://bug-tracker-backend-2z4i.onrender.com/api/health)
          
          if echo "$health_response" | grep -q "OK"; then
            echo "‚úÖ Database connection is healthy"
          else
            echo "‚ùå Database might have connection issues"
            echo "$health_response"
            exit 1
          fi
      
      - name: Performance Check
        run: |
          echo "‚ö° Testing response times..."
          
          start_time=$(date +%s%3N)
          curl -s https://bug-tracker-backend-2z4i.onrender.com/api/health > /dev/null
          end_time=$(date +%s%3N)
          response_time=$((end_time - start_time))
          
          echo "Backend response time: ${response_time}ms"
          
          if [ $response_time -lt 5000 ]; then
            echo "‚úÖ Response time is good (< 5s)"
          else
            echo "‚ö†Ô∏è  Response time is slow (> 5s) - might be a cold start"
          fi

  integration-test:
    name: Integration Tests
    runs-on: windows-latest
    needs: [smoke-test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Test Full Bug Lifecycle
        run: |
          echo "üîÑ Testing full CRUD operations..."
          
          # Create a test bug
          echo "Creating test bug..."
          create_response=$(curl -s -X POST https://bug-tracker-backend-2z4i.onrender.com/api/bugs \
            -H "Content-Type: application/json" \
            -d '{
              "title": "E2E Test Bug - '"$(date +%s)"'",
              "description": "This is an automated test bug",
              "severity": "low",
              "status": "open"
            }')
          
          bug_id=$(echo "$create_response" | jq -r '.data._id')
          
          if [ "$bug_id" != "null" ] && [ -n "$bug_id" ]; then
            echo "‚úÖ Bug created with ID: $bug_id"
          else
            echo "‚ùå Failed to create bug"
            echo "$create_response"
            exit 1
          fi
          
          # Read the bug
          echo "Reading bug..."
          read_status=$(curl -s -o /dev/null -w "%{http_code}" \
            https://bug-tracker-backend-2z4i.onrender.com/api/bugs/$bug_id)
          
          if [ "$read_status" -eq 200 ]; then
            echo "‚úÖ Bug retrieved successfully"
          else
            echo "‚ùå Failed to retrieve bug (HTTP $read_status)"
          fi
          
          # Update the bug
          echo "Updating bug..."
          update_status=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PUT https://bug-tracker-backend-2z4i.onrender.com/api/bugs/$bug_id \
            -H "Content-Type: application/json" \
            -d '{"status": "resolved"}')
          
          if [ "$update_status" -eq 200 ]; then
            echo "‚úÖ Bug updated successfully"
          else
            echo "‚ùå Failed to update bug (HTTP $update_status)"
          fi
          
          # Delete the bug
          echo "Deleting bug..."
          delete_status=$(curl -s -o /dev/null -w "%{http_code}" \
            -X DELETE https://bug-tracker-backend-2z4i.onrender.com/api/bugs/$bug_id)
          
          if [ "$delete_status" -eq 200 ]; then
            echo "‚úÖ Bug deleted successfully"
          else
            echo "‚ùå Failed to delete bug (HTTP $delete_status)"
          fi
          
          echo "‚úÖ Full CRUD lifecycle test passed!"

  notify:
    name: Send Test Results
    runs-on: windows-latest
    needs: [smoke-test, integration-test]
    if: always()
    
    steps:
      - name: Send Slack notification
        if: secrets.SLACK_WEBHOOK != ''
        run: |
          if [ "${{ needs.smoke-test.result }}" == "success" ] && [ "${{ needs.integration-test.result }}" == "success" ]; then
            emoji="‚úÖ"
            color="good"
            text="All E2E tests passed!"
          else
            emoji="‚ùå"
            color="danger"
            text="Some E2E tests failed!"
          fi
          
          curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$emoji E2E Test Results\",
              \"attachments\": [{
                \"color\": \"$color\",
                \"fields\": [
                  {\"title\": \"Status\", \"value\": \"$text\", \"short\": false},
                  {\"title\": \"Smoke Tests\", \"value\": \"${{ needs.smoke-test.result }}\", \"short\": true},
                  {\"title\": \"Integration Tests\", \"value\": \"${{ needs.integration-test.result }}\", \"short\": true},
                  {\"title\": \"Frontend\", \"value\": \"https://deployment-and-devops-essentials-moen.onrender.com\", \"short\": false},
                  {\"title\": \"Backend\", \"value\": \"https://bug-tracker-backend-2z4i.onrender.com\", \"short\": false}
                ]
              }]
            }" || echo "Slack notification failed"
        continue-on-error: true